<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  #map { height: 600px; width: 100%; }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
async function login() {
  const password = prompt("Enter password:");
  try {
    const res = await fetch('http://localhost:3000/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    if (!res.ok) throw new Error('Wrong password');
    return await res.json();
  } catch (err) {
    document.body.innerHTML = "<h1>Access Denied</h1>";
    throw err;
  }
}

async function initMap() {
  await login(); // wait for server authentication

  // Initialize map
  const map = L.map('map').setView([45.5017, -73.5673], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  const markerGroup = L.layerGroup().addTo(map);

  async function fetchWaypoints() {
    try {
      const res = await fetch('http://localhost:3000/camps');
      const data = await res.json();

      markerGroup.clearLayers(); // efficient update

      data.forEach(loc => {
        const popupContent = `
          <strong>${loc.name}</strong><br>
          Date: ${loc.date}<br>
          Time: ${loc.nowtime}<br>
          Notes: ${loc.campnotes}
        `;
        L.marker([loc.expertlat, loc.expertlon])
          .bindPopup(popupContent, { autoClose: false, closeOnClick: false })
          .addTo(markerGroup);
      });
    } catch (err) {
      console.error('Failed to fetch waypoints:', err);
    }
  }

  fetchWaypoints();
  setInterval(fetchWaypoints, 5000); // refresh every 5 seconds
}

initMap();
</script>

</body>
</html>
